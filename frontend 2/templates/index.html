<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVRP Agent System - Python Frontend</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #d0d0d0;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        select, button, input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        button.danger {
            background: #f44336;
        }
        
        button.danger:hover {
            background: #d32f2f;
        }
        
        button.success {
            background: #4caf50;
        }
        
        button.success:hover {
            background: #45a049;
        }
        
        #map-container {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            position: relative;
            background: #f9f9f9;
        }
        
        #visualization {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .log-viewer {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .log-entry.error {
            border-left-color: #f44336;
            color: #ff6b6b;
        }
        
        .log-entry.warning {
            border-left-color: #ff9800;
            color: #ffb74d;
        }
        
        .log-entry.event {
            border-left-color: #2196f3;
            color: #64b5f6;
        }
        
        .log-entry.message {
            border-left-color: #4caf50;
            color: #81c784;
        }
        
        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }
        
        .test-case-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .test-case-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .test-case-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .test-case-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .test-case-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .test-case-info {
            color: #666;
            font-size: 14px;
        }
        
        .customer-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .customer-item:last-child {
            border-bottom: none;
        }
        
        .customer-item button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .status-badge.pending {
            background: #ff9800;
            color: white;
        }
        
        .status-badge.processing {
            background: #2196f3;
            color: white;
        }
        
        .status-badge.completed {
            background: #4caf50;
            color: white;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        
        .node {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        
        .node:hover {
            transform: scale(1.3);
            z-index: 10;
        }
        
        .node.depot {
            background: #f44336;
            width: 30px;
            height: 30px;
        }
        
        .node.customer {
            background: #2196f3;
        }
        
        .node.selected {
            background: #4caf50;
            border-color: #2e7d32;
        }
        
        .node-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸšš CVRP Agent System - Python Frontend</h1>
            <p>Interactive CVRP problem solver with real-time agent monitoring</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', event)">MAS Dashboard</button>
            <button class="tab" onclick="switchTab('problem', event)">Problem Setup</button>
            <button class="tab" onclick="switchTab('monitor', event)">Real-time Monitor</button>
            <button class="tab" onclick="switchTab('test-cases', event)">Test Cases</button>
            <button class="tab" onclick="switchTab('logs', event)">Agent Logs</button>
        </div>
        
        <!-- MAS Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="control-panel">
                <select id="dashboard-log-folder">
                    <option value="">Select log folder...</option>
                </select>
                <button onclick="loadDashboard()">Load Dashboard</button>
                <button onclick="startDashboardAutoRefresh()">Auto Refresh</button>
                <button onclick="stopDashboardAutoRefresh()" class="danger">Stop</button>
            </div>
            
            <div class="two-column" style="margin-top: 20px;">
                <div>
                    <h3>MRA (Master Routing Agent) Status</h3>
                    <div id="mra-status" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <p>Select a log folder to view status</p>
                    </div>
                </div>
                <div>
                    <h3>DA (Delivery Agent) Status</h3>
                    <div id="da-status" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <p>Select a log folder to view status</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>Agent Communication Flow</h3>
                <div id="communication-flow" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px; max-height: 300px; overflow-y: auto;">
                    <p>Communication events will appear here</p>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>Real-time DA Movement</h3>
                <div id="da-movement-viz" style="height: 500px; border: 1px solid #ddd; border-radius: 5px;"></div>
            </div>
        </div>
        
        <!-- Problem Setup Tab -->
        <div id="problem-tab" class="tab-content">
            <div class="control-panel">
                <label><strong>Depot:</strong></label>
                <input type="number" id="depot-x" placeholder="X" value="0" step="0.1">
                <input type="number" id="depot-y" placeholder="Y" value="0" step="0.1">
                <button onclick="setDepot()">Set Depot</button>
                <button onclick="clearMap()" class="danger">Clear All</button>
            </div>
            
            <div class="control-panel">
                <label><strong>Add Customer:</strong></label>
                <input type="number" id="customer-x" placeholder="X" step="0.1">
                <input type="number" id="customer-y" placeholder="Y" step="0.1">
                <input type="number" id="customer-demand" placeholder="Demand" value="10" min="1">
                <button onclick="addCustomerFromInput()">Add Customer</button>
            </div>
            
            <div id="map-container" onclick="addCustomerFromClick(event)">
                <div id="map-nodes"></div>
            </div>
            
            <div class="two-column">
                <div>
                    <h3>Customers</h3>
                    <div id="customer-list" class="customer-list"></div>
                </div>
                <div>
                    <h3>Vehicles</h3>
                    <div class="control-panel">
                        <input type="text" id="vehicle-name" placeholder="Vehicle Name" value="DA1">
                        <input type="number" id="vehicle-capacity" placeholder="Capacity" value="50" min="1">
                        <input type="number" id="vehicle-maxdist" placeholder="Max Distance" value="1000" min="1" step="0.1">
                        <button onclick="addVehicle()">Add Vehicle</button>
                    </div>
                    <div id="vehicle-list" class="customer-list"></div>
                </div>
            </div>
            
            <div class="control-panel" style="margin-top: 20px;">
                <button onclick="submitProblem()" class="success" style="padding: 15px 30px; font-size: 16px;">
                    Submit Problem to Backend
                </button>
                <span id="submit-status"></span>
            </div>
        </div>
        
        <!-- Real-time Monitor Tab -->
        <div id="monitor-tab" class="tab-content">
            <div class="control-panel">
                <input type="text" id="monitor-request-id" placeholder="Request ID">
                <button onclick="startMonitoring()">Start Monitoring</button>
                <button onclick="stopMonitoring()" class="danger">Stop</button>
                <button onclick="loadLatestLogs()">Load Latest Logs</button>
            </div>
            
            <div id="monitor-status"></div>
            
            <div style="margin-top: 20px;">
                <h3>Real-time Visualization</h3>
                <div id="monitor-visualization" style="height: 600px; border: 1px solid #ddd; border-radius: 5px;"></div>
            </div>
            
            <div class="two-column" style="margin-top: 20px;">
                <div>
                    <h3>Route Queue Status</h3>
                    <div id="route-queue-status" style="background: #f9f9f9; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;">
                        <p>Waiting for solution...</p>
                    </div>
                </div>
                <div>
                    <h3>DA Movement Status</h3>
                    <div id="da-movement-status" style="background: #f9f9f9; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;">
                        <p>Waiting for movement data...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Cases Tab -->
        <div id="test-cases-tab" class="tab-content">
            <div class="control-panel">
                <button onclick="loadTestCases()">Refresh Test Cases</button>
                <button onclick="visualizeTestCase()">Visualize Selected</button>
            </div>
            <div id="test-case-list" class="test-case-list"></div>
            <div id="test-case-visualization" style="height: 600px; border: 1px solid #ddd; border-radius: 5px; margin-top: 20px;"></div>
        </div>
        
        <!-- Agent Logs Tab -->
        <div id="logs-tab" class="tab-content">
            <div class="control-panel">
                <select id="log-folder-select">
                    <option value="">Select log folder...</option>
                </select>
                <select id="agent-select" disabled>
                    <option value="">Select agent...</option>
                </select>
                <button onclick="loadLogs()">Load Logs</button>
                <button onclick="startRealTimeLogs()">Real-time Mode</button>
                <button onclick="stopRealTimeLogs()" class="danger">Stop Real-time</button>
            </div>
            <div id="log-viewer" class="log-viewer">
                <p style="text-align: center; color: #888;">Select a log folder and agent to view logs</p>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let customers = [];
        let vehicles = [];
        let depot = { x: 0, y: 0 };
        let selectedTestCase = null;
        let monitoringInterval = null;
        let realTimeLogInterval = null;
        let currentRequestId = null;
        let monitorRequestData = null; // Store original request data for visualization
        let latestSolution = null; // Store latest solution
        
        // Tab switching
        function switchTab(tabName, eventElement) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Find the tab button and activate it
            const tabs = document.querySelectorAll('.tab');
            for (let tab of tabs) {
                if (tab.textContent.includes(tabName.replace('-', ' ')) || 
                    tab.getAttribute('onclick')?.includes(tabName)) {
                    tab.classList.add('active');
                    break;
                }
            }
            
            // If called programmatically, find tab by matching text
            if (!eventElement) {
                const tabButtons = Array.from(document.querySelectorAll('.tab'));
                const matchingTab = tabButtons.find(tab => {
                    const onclick = tab.getAttribute('onclick') || '';
                    return onclick.includes(tabName);
                });
                if (matchingTab) {
                    matchingTab.classList.add('active');
                }
            } else if (eventElement && eventElement.target) {
                eventElement.target.classList.add('active');
            }
            
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // Map functions
        function addCustomerFromClick(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const demand = parseInt(prompt('Enter demand:', '10')) || 10;
            addCustomer(x, y, demand);
        }
        
        function addCustomerFromInput() {
            const x = parseFloat(document.getElementById('customer-x').value);
            const y = parseFloat(document.getElementById('customer-y').value);
            const demand = parseInt(document.getElementById('customer-demand').value);
            
            if (isNaN(x) || isNaN(y) || isNaN(demand)) {
                alert('Please enter valid values');
                return;
            }
            
            addCustomer(x, y, demand);
        }
        
        function addCustomer(x, y, demand) {
            const id = customers.length + 1;
            customers.push({ id: id.toString(), x, y, demand });
            renderMap();
            renderCustomerList();
        }
        
        function setDepot() {
            const x = parseFloat(document.getElementById('depot-x').value);
            const y = parseFloat(document.getElementById('depot-y').value);
            
            if (isNaN(x) || isNaN(y)) {
                alert('Please enter valid coordinates');
                return;
            }
            
            depot = { x, y };
            renderMap();
        }
        
        function clearMap() {
            if (confirm('Clear all customers and reset?')) {
                customers = [];
                vehicles = [];
                depot = { x: 0, y: 0 };
                document.getElementById('depot-x').value = 0;
                document.getElementById('depot-y').value = 0;
                renderMap();
                renderCustomerList();
                renderVehicleList();
            }
        }
        
        function renderMap() {
            const container = document.getElementById('map-container');
            const nodesDiv = document.getElementById('map-nodes');
            nodesDiv.innerHTML = '';
            
            // Draw depot
            const depotNode = document.createElement('div');
            depotNode.className = 'node depot';
            depotNode.style.left = depot.x + 'px';
            depotNode.style.top = depot.y + 'px';
            depotNode.title = `Depot (${depot.x}, ${depot.y})`;
            const depotLabel = document.createElement('div');
            depotLabel.className = 'node-label';
            depotLabel.textContent = 'Depot';
            depotNode.appendChild(depotLabel);
            nodesDiv.appendChild(depotNode);
            
            // Draw customers
            customers.forEach(customer => {
                const node = document.createElement('div');
                node.className = 'node customer';
                node.style.left = customer.x + 'px';
                node.style.top = customer.y + 'px';
                node.title = `Customer ${customer.id}: Demand ${customer.demand} at (${customer.x}, ${customer.y})`;
                node.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete customer ${customer.id}?`)) {
                        customers = customers.filter(c => c.id !== customer.id);
                        renderMap();
                        renderCustomerList();
                    }
                };
                
                const label = document.createElement('div');
                label.className = 'node-label';
                label.textContent = `C${customer.id} (${customer.demand})`;
                node.appendChild(label);
                nodesDiv.appendChild(node);
            });
        }
        
        function renderCustomerList() {
            const list = document.getElementById('customer-list');
            list.innerHTML = customers.map(c => `
                <div class="customer-item">
                    <span>C${c.id}: (${c.x}, ${c.y}) - Demand: ${c.demand}</span>
                    <button onclick="removeCustomer('${c.id}')" class="danger">Remove</button>
                </div>
            `).join('');
        }
        
        function removeCustomer(id) {
            customers = customers.filter(c => c.id !== id);
            renderMap();
            renderCustomerList();
        }
        
        function addVehicle() {
            const name = document.getElementById('vehicle-name').value || `DA${vehicles.length + 1}`;
            const capacity = parseInt(document.getElementById('vehicle-capacity').value);
            const maxDistance = parseFloat(document.getElementById('vehicle-maxdist').value);
            
            if (!name || isNaN(capacity) || isNaN(maxDistance)) {
                alert('Please enter valid vehicle data');
                return;
            }
            
            vehicles.push({ name, capacity, maxDistance });
            renderVehicleList();
        }
        
        function renderVehicleList() {
            const list = document.getElementById('vehicle-list');
            list.innerHTML = vehicles.map((v, i) => `
                <div class="customer-item">
                    <span>${v.name}: Capacity ${v.capacity}, Max Distance ${v.maxDistance}</span>
                    <button onclick="removeVehicle(${i})" class="danger">Remove</button>
                </div>
            `).join('');
        }
        
        function removeVehicle(index) {
            vehicles.splice(index, 1);
            renderVehicleList();
        }
        
        // Submit problem to backend
        async function submitProblem() {
            if (customers.length === 0) {
                alert('Please add at least one customer');
                return;
            }
            
            if (vehicles.length === 0) {
                alert('Please add at least one vehicle');
                return;
            }
            
            const requestData = {
                depot: {
                    name: 'mra',
                    x: depot.x,
                    y: depot.y
                },
                vehicles: vehicles,
                customers: customers.map(c => ({
                    id: c.id,
                    x: c.x,
                    y: c.y,
                    demand: c.demand
                }))
            };
            
            const statusEl = document.getElementById('submit-status');
            statusEl.innerHTML = '<span class="status-badge processing">Submitting...</span>';
            
            try {
                const response = await fetch('/api/submit-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (response.status === 202) {
                    currentRequestId = data.request_id;
                    // Store request data for visualization
                    monitorRequestData = requestData;
                    statusEl.innerHTML = `<span class="status-badge completed">Submitted! Request ID: ${data.request_id}</span>`;
                    alert(`Problem submitted! Request ID: ${data.request_id}\n\nSwitch to "Real-time Monitor" tab to track progress.`);
                } else {
                    statusEl.innerHTML = `<span class="status-badge error">Error: ${data.error}</span>`;
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                statusEl.innerHTML = `<span class="status-badge error">Error: ${error.message}</span>`;
                alert('Error submitting: ' + error.message);
            }
        }
        
        // Real-time monitoring
        async function startMonitoring() {
            const requestId = document.getElementById('monitor-request-id').value || currentRequestId;
            
            if (!requestId) {
                alert('Please enter a request ID or submit a problem first');
                return;
            }
            
            currentRequestId = requestId;
            stopMonitoring();
            
            const statusEl = document.getElementById('monitor-status');
            statusEl.innerHTML = '<span class="status-badge processing">Monitoring...</span>';
            
            // Try to get the latest log folder for DA movements
            let latestLogFolder = null;
            try {
                const logResponse = await fetch('/api/latest-logs');
                const logData = await logResponse.json();
                if (logData.folder) {
                    latestLogFolder = logData.folder;
                }
            } catch (e) {
                console.log('Could not get latest log folder:', e);
            }
            
            // Initial visualization
            updateMonitorVisualization(null, latestLogFolder);
            
            monitoringInterval = setInterval(async () => {
                try {
                    // Get solution status
                    const response = await fetch(`/api/solution/${requestId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed' && data.solution) {
                        statusEl.innerHTML = '<span class="status-badge completed">Solution Ready!</span>';
                        latestSolution = data.solution;
                        
                        // Get latest log folder for movements
                        try {
                            const logResponse = await fetch('/api/latest-logs');
                            const logData = await logResponse.json();
                            if (logData.folder) {
                                latestLogFolder = logData.folder;
                            }
                        } catch (e) {
                            console.log('Could not get latest log folder:', e);
                        }
                        
                        // Update visualization with solution and movements
                        updateMonitorVisualization(data.solution, latestLogFolder);
                        updateRouteQueueStatus(data.solution);
                        
                        // Continue monitoring for DA movements even after solution is ready
                    } else {
                        statusEl.innerHTML = `<span class="status-badge ${data.status}">Status: ${data.status}</span>`;
                        
                        // Still try to show movements if available
                        if (latestLogFolder) {
                            updateMonitorVisualization(latestSolution, latestLogFolder);
                        }
                    }
                    
                    // Update DA movement status
                    if (latestLogFolder) {
                        updateDAMovementStatus(latestLogFolder);
                    }
                    
                } catch (error) {
                    console.error('Monitoring error:', error);
                }
            }, 2000);
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }
        
        async function updateMonitorVisualization(solution, logFolder) {
            const vizDiv = document.getElementById('monitor-visualization');
            const traces = [];
            const colors = ['#2196f3', '#4caf50', '#ff9800', '#f44336', '#9c27b0', '#00bcd4'];
            
            // Get depot from solution, monitorRequestData, or global depot
            let currentDepot = { x: 0, y: 0 };
            if (solution && solution.depot) {
                currentDepot = solution.depot;
            } else if (monitorRequestData && monitorRequestData.depot) {
                currentDepot = monitorRequestData.depot;
            } else if (depot && depot.x !== undefined) {
                currentDepot = depot;
            }
            
            // Plot depot
            traces.push({
                x: [currentDepot.x],
                y: [currentDepot.y],
                mode: 'markers',
                name: 'Depot',
                marker: { size: 15, color: '#f44336', symbol: 'square' },
                hovertemplate: '<b>Depot</b><br>X: %{x}<br>Y: %{y}<extra></extra>'
            });
            
            // Plot all customers (from solution or request data)
            let allCustomers = [];
            if (solution && solution.routes) {
                // Get all customers from routes
                solution.routes.forEach(route => {
                    route.customers.forEach(c => {
                        if (!allCustomers.find(existing => existing.id === c.id)) {
                            allCustomers.push(c);
                        }
                    });
                });
                // Add unserved customers
                if (solution.unservedCustomers) {
                    solution.unservedCustomers.forEach(c => {
                        if (!allCustomers.find(existing => existing.id === c.id)) {
                            allCustomers.push(c);
                        }
                    });
                }
            } else if (monitorRequestData && monitorRequestData.customers) {
                allCustomers = monitorRequestData.customers;
            }
            
            if (allCustomers.length > 0) {
                const customerX = allCustomers.map(c => c.x);
                const customerY = allCustomers.map(c => c.y);
                
                traces.push({
                    x: customerX,
                    y: customerY,
                    mode: 'markers',
                    name: 'Customers',
                    marker: { size: 10, color: '#2196f3', symbol: 'circle' },
                    hovertemplate: '<b>Customer %{text}</b><br>X: %{x}<br>Y: %{y}<br>Demand: %{customdata}<extra></extra>',
                    text: allCustomers.map(c => c.id || c.name || '?'),
                    customdata: allCustomers.map(c => c.demand || '?')
                });
            }
            
            // Plot routes from solution
            if (solution && solution.routes) {
                solution.routes.forEach((route, idx) => {
                    const x = [currentDepot.x];
                    const y = [currentDepot.y];
                    
                    route.customers.forEach(customer => {
                        x.push(customer.x);
                        y.push(customer.y);
                    });
                    
                    x.push(currentDepot.x);
                    y.push(currentDepot.y);
                    
                    traces.push({
                        x: x,
                        y: y,
                        mode: 'lines+markers',
                        name: route.vehicleName || `Route ${idx + 1}`,
                        line: { width: 3, color: colors[idx % colors.length], dash: 'dash' },
                        marker: { size: 6, color: colors[idx % colors.length] },
                        hovertemplate: `<b>${route.vehicleName || `Route ${idx + 1}`}</b><br>Customers: ${route.customers.length}<br>Distance: ${route.distance ? route.distance.toFixed(2) : 'N/A'}<extra></extra>`
                    });
                });
            }
            
            // Plot unserved customers
            if (solution && solution.unservedCustomers && solution.unservedCustomers.length > 0) {
                const unservedX = solution.unservedCustomers.map(c => c.x);
                const unservedY = solution.unservedCustomers.map(c => c.y);
                
                traces.push({
                    x: unservedX,
                    y: unservedY,
                    mode: 'markers',
                    name: 'Unserved',
                    marker: { size: 12, color: 'red', symbol: 'x' },
                    hovertemplate: '<b>Unserved Customer</b><br>X: %{x}<br>Y: %{y}<extra></extra>'
                });
            }
            
            // Load and plot DA movements from logs
            if (logFolder) {
                try {
                    const movementResponse = await fetch(`/api/da-movements/${logFolder}`);
                    const movementData = await movementResponse.json();
                    
                    if (movementData.movements) {
                        let daColorIndex = 0;
                        for (const [daName, positions] of Object.entries(movementData.movements)) {
                            if (positions.length > 0) {
                                const x = positions.map(p => p.x);
                                const y = positions.map(p => p.y);
                                
                                traces.push({
                                    x: x,
                                    y: y,
                                    mode: 'lines+markers',
                                    name: `${daName} (Movement)`,
                                    line: { width: 2, color: colors[daColorIndex % colors.length] },
                                    marker: { 
                                        size: 6,
                                        color: positions.map(p => {
                                            if (p.event === 'depot') return '#f44336';
                                            if (p.event === 'arrival') return '#4caf50';
                                            return colors[daColorIndex % colors.length];
                                        })
                                    },
                                    hovertemplate: `<b>${daName}</b><br>Event: %{customdata}<br>X: %{x}<br>Y: %{y}<extra></extra>`,
                                    customdata: positions.map(p => p.event || 'moving')
                                });
                                
                                daColorIndex++;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Could not load DA movements:', error);
                }
            }
            
            const layout = {
                title: 'Real-time CVRP Visualization',
                xaxis: { title: 'X Coordinate' },
                yaxis: { title: 'Y Coordinate', scaleanchor: 'x' },
                hovermode: 'closest',
                showlegend: true
            };
            
            Plotly.newPlot(vizDiv, traces, layout);
        }
        
        async function updateDAMovementStatus(logFolder) {
            const statusDiv = document.getElementById('da-movement-status');
            
            if (!logFolder) {
                statusDiv.innerHTML = '<p>No log folder available</p>';
                return;
            }
            
            try {
                const response = await fetch(`/api/da-movements/${logFolder}`);
                const data = await response.json();
                
                if (!data.queue_status || Object.keys(data.queue_status).length === 0) {
                    statusDiv.innerHTML = '<p>No DA movement data available</p>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 10px;">';
                
                for (const [daName, queueInfo] of Object.entries(data.queue_status)) {
                    const movements = data.movements[daName] || [];
                    const lastPosition = movements.length > 0 ? movements[movements.length - 1] : null;
                    
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${daName}</div>
                            <div style="font-size: 12px; color: #666;">
                                <div><strong>Queue Size:</strong> ${queueInfo.queue_size || 0}</div>
                                <div><strong>Current Route:</strong> ${queueInfo.current_route || 'None'}</div>
                                ${lastPosition ? `
                                    <div style="margin-top: 5px;">
                                        <strong>Last Position:</strong> (${lastPosition.x.toFixed(2)}, ${lastPosition.y.toFixed(2)})
                                    </div>
                                    <div><strong>Last Event:</strong> ${lastPosition.event || 'moving'}</div>
                                ` : ''}
                                <div><strong>Total Movements:</strong> ${movements.length}</div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #f44336;">Error: ${error.message}</p>`;
            }
        }
        
        function visualizeSolution(solution) {
            // Legacy function - redirect to new function
            updateMonitorVisualization(solution, null);
        }
        
        function updateRouteQueueStatus(solution) {
            const statusDiv = document.getElementById('route-queue-status');
            
            if (!solution || !solution.routes) {
                statusDiv.innerHTML = '<p>No route information available</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            
            solution.routes.forEach((route, idx) => {
                html += `
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            ${route.vehicleName || `Route ${idx + 1}`}
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            <div><strong>Customers:</strong> ${route.customers.length}</div>
                            <div><strong>Distance:</strong> ${route.distance ? route.distance.toFixed(2) : 'N/A'}</div>
                            <div><strong>Demand:</strong> ${route.customers.reduce((sum, c) => sum + (c.demand || 0), 0)}</div>
                            <div style="margin-top: 5px;">
                                <strong>Route:</strong> 
                                <span style="font-family: monospace; font-size: 10px;">
                                    Depot â†’ ${route.customers.map(c => `C${c.id || c.name || '?'}`).join(' â†’ ')} â†’ Depot
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (solution.unservedCustomers && solution.unservedCustomers.length > 0) {
                html += `
                    <div style="border: 1px solid #f44336; padding: 10px; border-radius: 5px; background: #ffebee;">
                        <div style="font-weight: bold; color: #f44336; margin-bottom: 5px;">
                            âš  Unserved Customers: ${solution.unservedCustomers.length}
                        </div>
                        <div style="font-size: 12px;">
                            ${solution.unservedCustomers.map(c => `C${c.id || c.name || '?'}`).join(', ')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }
        
        // Test cases
        async function loadTestCases() {
            const listDiv = document.getElementById('test-case-list');
            listDiv.innerHTML = '<p>Loading test cases...</p>';
            
            try {
                const response = await fetch('/api/test-cases');
                const testCases = await response.json();
                
                if (testCases.length === 0) {
                    listDiv.innerHTML = '<p>No test cases found</p>';
                    return;
                }
                
                listDiv.innerHTML = testCases.map(tc => `
                    <div class="test-case-card" onclick="loadAndSubmitTestCase('${tc.filename}')" id="tc-${tc.filename}">
                        <h3>${tc.name}</h3>
                        <div class="test-case-info">
                            <p><strong>File:</strong> ${tc.filename}</p>
                            <p><strong>Vehicles:</strong> ${tc.vehicles_count}</p>
                            <p><strong>Customers:</strong> ${tc.customers_count}</p>
                            <p><strong>Depot:</strong> (${tc.depot.x}, ${tc.depot.y})</p>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #667eea;">
                            Click to load and submit to backend â†’
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                listDiv.innerHTML = `<p style="color: #f44336;">Error: ${error.message}</p>`;
            }
        }
        
        function selectTestCase(filename) {
            document.querySelectorAll('.test-case-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('tc-' + filename).classList.add('selected');
            selectedTestCase = filename;
        }
        
        async function loadAndSubmitTestCase(filename) {
            try {
                // Show loading state
                const card = document.getElementById('tc-' + filename);
                if (card) {
                    card.style.opacity = '0.6';
                    card.style.pointerEvents = 'none';
                }
                
                // Load test case data
                const response = await fetch(`/api/test-cases/${filename}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error loading test case: ' + data.error);
                    if (card) {
                        card.style.opacity = '1';
                        card.style.pointerEvents = 'auto';
                    }
                    return;
                }
                
                // Select the test case
                selectTestCase(filename);
                
                // Visualize the test case
                await visualizeTestCaseData(data, filename);
                
                // Prepare data for backend submission
                const requestData = {
                    depot: {
                        name: data.depot.name || 'mra',
                        x: data.depot.x,
                        y: data.depot.y
                    },
                    vehicles: data.vehicles.map(v => ({
                        name: v.name,
                        capacity: v.capacity,
                        maxDistance: v.maxDistance
                    })),
                    customers: data.customers.map(c => ({
                        id: c.id,
                        x: c.x,
                        y: c.y,
                        demand: c.demand
                    }))
                };
                
                // Submit to backend
                console.log('Submitting test case to backend:', requestData);
                
                const submitResponse = await fetch('/api/submit-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const submitData = await submitResponse.json();
                
                if (submitResponse.status === 202) {
                    currentRequestId = submitData.request_id;
                    // Store request data for visualization
                    monitorRequestData = requestData;
                    
                    // Show success message
                    alert(`Test case "${filename}" submitted successfully!\n\nRequest ID: ${submitData.request_id}\n\nSwitch to "Real-time Monitor" tab to track progress.`);
                    
                    // Auto-switch to monitor tab and start monitoring
                    switchTab('monitor');
                    document.getElementById('monitor-request-id').value = submitData.request_id;
                    setTimeout(() => {
                        startMonitoring();
                    }, 500);
                } else {
                    alert('Error submitting test case: ' + (submitData.error || 'Unknown error'));
                }
                
                // Restore card state
                if (card) {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
                
            } catch (error) {
                alert('Error: ' + error.message);
                const card = document.getElementById('tc-' + filename);
                if (card) {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
            }
        }
        
        async function visualizeTestCase() {
            if (!selectedTestCase) {
                alert('Please select a test case first');
                return;
            }
            
            try {
                const response = await fetch(`/api/test-cases/${selectedTestCase}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                await visualizeTestCaseData(data, selectedTestCase);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function visualizeTestCaseData(data, filename) {
            const vizDiv = document.getElementById('test-case-visualization');
            const traces = [];
            
            // Depot
            traces.push({
                x: [data.depot.x],
                y: [data.depot.y],
                mode: 'markers',
                name: 'Depot',
                marker: { size: 15, color: 'red', symbol: 'square' }
            });
            
            // Customers
            const customerX = data.customers.map(c => c.x);
            const customerY = data.customers.map(c => c.y);
            
            traces.push({
                x: customerX,
                y: customerY,
                mode: 'markers+text',
                name: 'Customers',
                text: data.customers.map(c => `C${c.id}`),
                textposition: 'top',
                marker: { size: 10, color: 'blue' },
                hovertemplate: '<b>%{text}</b><br>X: %{x}<br>Y: %{y}<br>Demand: %{customdata}<extra></extra>',
                customdata: data.customers.map(c => c.demand)
            });
            
            const layout = {
                title: `Test Case: ${filename}`,
                xaxis: { title: 'X Coordinate' },
                yaxis: { title: 'Y Coordinate' },
                hovermode: 'closest'
            };
            
            Plotly.newPlot(vizDiv, traces, layout);
        }
        
        // Logs
        async function loadLogFolders() {
            try {
                const response = await fetch('/api/log-folders');
                const folders = await response.json();
                
                const select = document.getElementById('log-folder-select');
                select.innerHTML = '<option value="">Select log folder...</option>';
                
                folders.forEach(folder => {
                    select.add(new Option(folder.name, folder.name));
                });
            } catch (error) {
                console.error('Error loading log folders:', error);
            }
        }
        
        document.getElementById('log-folder-select').addEventListener('change', async function() {
            const folder = this.value;
            const agentSelect = document.getElementById('agent-select');
            
            if (!folder) {
                agentSelect.disabled = true;
                agentSelect.innerHTML = '<option value="">Select agent...</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/logs/${folder}/agents`);
                const agents = await response.json();
                
                agentSelect.disabled = false;
                agentSelect.innerHTML = '<option value="">Select agent...</option>';
                agents.forEach(agent => {
                    agentSelect.add(new Option(agent, agent));
                });
            } catch (error) {
                console.error('Error loading agents:', error);
            }
        });
        
        async function loadLogs() {
            const folder = document.getElementById('log-folder-select').value;
            const agent = document.getElementById('agent-select').value;
            
            if (!folder || !agent) {
                alert('Please select both log folder and agent');
                return;
            }
            
            const viewer = document.getElementById('log-viewer');
            viewer.innerHTML = '<p>Loading logs...</p>';
            
            try {
                const response = await fetch(`/api/logs/${folder}/${agent}`);
                const data = await response.json();
                
                if (data.error) {
                    viewer.innerHTML = `<p style="color: #f44336;">Error: ${data.error}</p>`;
                    return;
                }
                
                if (data.entries.length === 0) {
                    viewer.innerHTML = '<p>No log entries found</p>';
                    return;
                }
                
                viewer.innerHTML = data.entries.map(entry => {
                    const level = entry.level || 'info';
                    return `<div class="log-entry ${level}">
                        <span class="log-timestamp">[${entry.timestamp}]</span>
                        ${entry.message.replace(/\n/g, '<br>')}
                    </div>`;
                }).join('');
                
                viewer.scrollTop = viewer.scrollHeight;
            } catch (error) {
                viewer.innerHTML = `<p style="color: #f44336;">Error: ${error.message}</p>`;
            }
        }
        
        async function startRealTimeLogs() {
            stopRealTimeLogs();
            
            realTimeLogInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/latest-logs');
                    const data = await response.json();
                    
                    if (data.folder) {
                        document.getElementById('log-folder-select').value = data.folder;
                        document.getElementById('log-folder-select').dispatchEvent(new Event('change'));
                        
                        if (data.agents.length > 0 && !document.getElementById('agent-select').value) {
                            document.getElementById('agent-select').value = data.agents[0];
                        }
                        
                        if (document.getElementById('agent-select').value) {
                            loadLogs();
                        }
                    }
                } catch (error) {
                    console.error('Real-time log error:', error);
                }
            }, 3000);
        }
        
        function stopRealTimeLogs() {
            if (realTimeLogInterval) {
                clearInterval(realTimeLogInterval);
                realTimeLogInterval = null;
            }
        }
        
        async function loadLatestLogs() {
            try {
                const response = await fetch('/api/latest-logs');
                const data = await response.json();
                
                if (data.folder) {
                    document.getElementById('log-folder-select').value = data.folder;
                    document.getElementById('log-folder-select').dispatchEvent(new Event('change'));
                }
            } catch (error) {
                console.error('Error loading latest logs:', error);
            }
        }
        
        // Dashboard functions
        let dashboardRefreshInterval = null;
        
        async function loadDashboard() {
            const folder = document.getElementById('dashboard-log-folder').value;
            if (!folder) {
                alert('Please select a log folder');
                return;
            }
            
            await updateDashboard(folder);
        }
        
        async function updateDashboard(folder) {
            try {
                // Load system state
                const stateResponse = await fetch(`/api/system-state/${folder}`);
                const stateData = await stateResponse.json();
                
                // Load communication flow
                const commResponse = await fetch(`/api/agent-communication/${folder}`);
                const commData = await commResponse.json();
                
                // Load DA movements
                const movementResponse = await fetch(`/api/da-movements/${folder}`);
                const movementData = await movementResponse.json();
                
                // Update MRA status
                updateMRAStatus(stateData.state.mra);
                
                // Update DA status
                updateDAStatus(stateData.state.das, movementData.queue_status);
                
                // Update communication flow
                updateCommunicationFlow(commData.communications);
                
                // Update DA movement visualization
                updateDAMovementViz(movementData.movements, movementData.routes);
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        function updateMRAStatus(mraState) {
            const statusDiv = document.getElementById('mra-status');
            
            if (!mraState || mraState.status === 'unknown') {
                statusDiv.innerHTML = '<p>No MRA data available</p>';
                return;
            }
            
            const statusColor = mraState.status === 'solved' ? '#4caf50' : 
                               mraState.status === 'solving' ? '#ff9800' : '#666';
            
            statusDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Status:</strong> 
                    <span style="color: ${statusColor}; font-weight: bold;">${mraState.status.toUpperCase()}</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Vehicles Queried:</strong> ${mraState.vehicles_queried || 0}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Routes Assigned:</strong> ${mraState.routes_assigned || 0}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Unserved Customers:</strong> 
                    <span style="color: ${mraState.unserved_customers > 0 ? '#f44336' : '#4caf50'};">
                        ${mraState.unserved_customers || 0}
                    </span>
                </div>
            `;
        }
        
        function updateDAStatus(dasState, queueStatus) {
            const statusDiv = document.getElementById('da-status');
            
            if (!dasState || Object.keys(dasState).length === 0) {
                statusDiv.innerHTML = '<p>No DA data available</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            
            for (const [daName, daState] of Object.entries(dasState)) {
                const queueInfo = queueStatus[daName] || {};
                const statusColor = daState.status === 'executing' ? '#2196f3' :
                                   daState.status === 'queued' ? '#ff9800' :
                                   daState.status === 'idle' ? '#4caf50' : '#666';
                
                html += `
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${daName}</div>
                        <div style="font-size: 12px; color: #666;">
                            <div><strong>Status:</strong> <span style="color: ${statusColor};">${daState.status}</span></div>
                            <div><strong>Queue Size:</strong> ${queueInfo.queue_size || daState.queue_size || 0}</div>
                            <div><strong>Current Route:</strong> ${queueInfo.current_route || daState.current_route || 'None'}</div>
                            <div><strong>Routes Completed:</strong> ${daState.routes_completed || 0}</div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }
        
        function updateCommunicationFlow(communications) {
            const flowDiv = document.getElementById('communication-flow');
            
            if (!communications || communications.length === 0) {
                flowDiv.innerHTML = '<p>No communication events found</p>';
                return;
            }
            
            flowDiv.innerHTML = communications.slice(-20).reverse().map(comm => {
                const icon = comm.type === 'query' ? 'ðŸ”' :
                            comm.type === 'route_assignment' ? 'ðŸ“‹' :
                            comm.type === 'route_response' ? 'âœ…' : 'ðŸ’¬';
                
                return `
                    <div style="padding: 5px; border-left: 3px solid #667eea; margin-bottom: 5px; font-size: 12px;">
                        ${icon} <strong>${comm.type.replace('_', ' ').toUpperCase()}</strong>
                        <br><span style="color: #666;">${comm.message || comm.content || ''}</span>
                        ${comm.timestamp ? `<br><span style="color: #999; font-size: 10px;">${comm.timestamp}</span>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateDAMovementViz(movements, routes) {
            const vizDiv = document.getElementById('da-movement-viz');
            
            if (!movements || Object.keys(movements).length === 0) {
                vizDiv.innerHTML = '<p style="text-align: center; padding: 20px;">No movement data available</p>';
                return;
            }
            
            const traces = [];
            const colors = ['#2196f3', '#4caf50', '#ff9800', '#f44336', '#9c27b0', '#00bcd4'];
            let colorIndex = 0;
            
            for (const [daName, positions] of Object.entries(movements)) {
                if (positions.length === 0) continue;
                
                const x = positions.map(p => p.x);
                const y = positions.map(p => p.y);
                const colors_array = positions.map(p => {
                    if (p.event === 'depot') return '#f44336';
                    if (p.event === 'arrival') return '#4caf50';
                    if (p.event === 'route_start') return '#2196f3';
                    return colors[colorIndex % colors.length];
                });
                
                // Movement path
                traces.push({
                    x: x,
                    y: y,
                    mode: 'lines+markers',
                    name: daName,
                    line: { width: 2, color: colors[colorIndex % colors.length] },
                    marker: { 
                        size: 8,
                        color: colors_array,
                        symbol: positions.map(p => {
                            if (p.event === 'depot') return 'square';
                            if (p.event === 'arrival') return 'circle';
                            return 'circle';
                        })
                    },
                    hovertemplate: `<b>${daName}</b><br>Event: %{customdata}<br>X: %{x}<br>Y: %{y}<extra></extra>`,
                    customdata: positions.map(p => p.event)
                });
                
                colorIndex++;
            }
            
            const layout = {
                title: 'DA Movement Visualization',
                xaxis: { title: 'X Coordinate' },
                yaxis: { title: 'Y Coordinate', scaleanchor: 'x' },
                hovermode: 'closest',
                showlegend: true
            };
            
            Plotly.newPlot(vizDiv, traces, layout);
        }
        
        function startDashboardAutoRefresh() {
            stopDashboardAutoRefresh();
            
            const folder = document.getElementById('dashboard-log-folder').value;
            if (!folder) {
                alert('Please select a log folder first');
                return;
            }
            
            dashboardRefreshInterval = setInterval(async () => {
                await updateDashboard(folder);
            }, 2000);
        }
        
        function stopDashboardAutoRefresh() {
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
        }
        
        // Initialize dashboard log folders
        async function loadDashboardLogFolders() {
            try {
                const response = await fetch('/api/log-folders');
                const folders = await response.json();
                
                const select = document.getElementById('dashboard-log-folder');
                select.innerHTML = '<option value="">Select log folder...</option>';
                
                folders.forEach(folder => {
                    select.add(new Option(folder.name, folder.name));
                });
            } catch (error) {
                console.error('Error loading log folders:', error);
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            loadLogFolders();
            loadDashboardLogFolders();
            loadTestCases();
            renderMap();
        });
    </script>
</body>
</html>
