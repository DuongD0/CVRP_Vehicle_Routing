<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVRP System - Main Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            border: 1px solid #667eea;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            border-color: #5568d3;
        }
        
        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #d5d8dc;
        }
        
        .btn-secondary:hover {
            background: #d5d8dc;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-btn:hover {
            background: #f5f5f5;
        }
        
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .customer-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .customer-item {
            background: #f5f5f5;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .customer-info {
            flex: 1;
        }
        
        .customer-name {
            font-weight: bold;
            color: #333;
        }
        
        .customer-details {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .map-container {
            flex: 1;
            background: white;
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            border-radius: 5px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }
        
        .log-timestamp {
            color: #858585;
        }
        
        .log-level-info {
            color: #4ec9b0;
        }
        
        .log-level-warning {
            color: #dcdcaa;
        }
        
        .log-level-error {
            color: #f48771;
        }
        
        .status-panel {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            color: #666;
            font-weight: 500;
        }
        
        .agent-info {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        
        .status-value {
            font-weight: 600;
            color: #27ae60;
        }
        
        .status-value.error {
            color: #e74c3c;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .vehicle-manager-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .vehicle-manager-overlay.active {
            display: flex;
        }

        .vehicle-manager-panel {
            background: white;
            width: 640px;
            max-height: 90vh;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .vehicle-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .vehicle-manager-body {
            padding: 20px;
            overflow-y: auto;
        }

        .vehicle-manager-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .vehicle-manager-close {
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            line-height: 1;
            color: #666;
        }

        .vehicle-manager-close:hover {
            color: #000;
        }

        .vehicle-manager-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 16px;
        }

        .vehicle-manager-list {
            border: 1px solid #eee;
            border-radius: 8px;
            max-height: 240px;
            overflow-y: auto;
        }

        .vehicle-manager-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .vehicle-manager-item:last-child {
            border-bottom: none;
        }

        .vehicle-manager-item-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .vehicle-manager-item-details {
            font-size: 13px;
            color: #7f8c8d;
        }

        .vehicle-manager-empty {
            padding: 24px;
            text-align: center;
            color: #999;
        }

        .vehicle-manager-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .vehicle-manager-actions .btn {
            flex: 1;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-panel {
            background: white;
            max-height: 90vh;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            line-height: 1;
            color: #666;
        }

        .modal-close:hover {
            color: #000;
        }

        .vehicle-manager-overlay .modal-panel {
            width: 640px;
        }

        .json-import-overlay .modal-panel {
            width: 520px;
        }

        .json-import-textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
        }

        .scenario-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .scenario-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .scenario-actions select {
            flex: 1;
        }

        .file-input {
            margin-top: 10px;
            font-size: 13px;
        }

        .helper-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸšš CVRP Multi-Agent System</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openVehicleManager()">Manage Vehicles</button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('customers')">Customers</button>
                <button class="tab-btn" onclick="switchTab('agents')">Agents</button>
                <button class="tab-btn" onclick="switchTab('logs')">Logs</button>
            </div>
            
            <div class="tab-content">
                <!-- Customers Tab -->
                <div id="customers-tab" class="tab-panel">
                    <div class="section">
                        <h2 class="section-title">Add Customer</h2>
                        <div id="customerMessage" class="message"></div>
                        <div class="form-group">
                            <label>Customer ID</label>
                            <input type="text" id="customerId" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label>Demand (items)</label>
                            <input type="number" id="customerDemand" placeholder="10" min="1">
                        </div>
                        <div class="form-group">
                            <label>X Coordinate</label>
                            <input type="number" id="customerX" placeholder="10.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Y Coordinate</label>
                            <input type="number" id="customerY" placeholder="10.0" step="0.1">
                        </div>
                        <button class="btn btn-primary" onclick="addCustomer()" style="width: 100%;">Add Customer</button>
                    </div>
                    
                    <div class="section">
                        <h2 class="section-title">Scenarios & Data</h2>
                        <div class="scenario-controls">
                            <div>
                                <label>Load Test Case</label>
                                <div class="scenario-actions">
                                    <select id="testCaseSelect">
                                        <option value="">Select a test case...</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="applySelectedTestCase()">Load</button>
                                </div>
                                <div class="helper-text">Loads predefined vehicles & customers from documentation.</div>
                            </div>
                            <div>
                                <label>Customer JSON</label>
                                <div class="scenario-actions" style="justify-content: flex-start;">
                                    <button class="btn btn-primary" onclick="openJsonImport()">Import JSON</button>
                                </div>
                                <div class="helper-text">Paste or upload JSON to replace the current customer list.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2 class="section-title">Customers List</h2>
                        <div id="customerList" class="customer-list">
                            <div style="text-align: center; color: #999; padding: 20px;">No customers added yet</div>
                        </div>
                        <button class="btn btn-success" onclick="submitRequest()" style="width: 100%; margin-top: 15px;">Submit Request</button>
                    </div>
                </div>
                
                <!-- Agents Tab -->
                <div id="agents-tab" class="tab-panel" style="display: none;">
                    <div class="section">
                        <h2 class="section-title">Agent Status</h2>
                        <div id="agentStatus" class="status-panel">
                            <div class="status-item">
                                <span class="status-label">MRA Status:</span>
                                <span class="status-value" id="mraStatus">Unknown</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Active DAs:</span>
                                <span class="status-value" id="daCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2 class="section-title">Available Agents</h2>
                        <div id="agentList"></div>
                    </div>
                </div>
                
                <!-- Logs Tab -->
                <div id="logs-tab" class="tab-panel" style="display: none;">
                    <div class="section">
                        <h2 class="section-title">Agent Logs</h2>
                        <div class="form-group">
                            <label>Select Agent</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="agentSelect" onchange="loadAgentLog()" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
                                    <option value="">Select an agent...</option>
                                </select>
                                <button onclick="loadAgentLog()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Refresh</button>
                            </div>
                        </div>
                        <div id="logViewer" class="log-viewer">
                            <div style="color: #858585;">Select an agent to view logs</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div id="vehicleManagerOverlay" class="modal-overlay vehicle-manager-overlay" aria-hidden="true">
        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="vehicleManagerTitle">
            <div class="modal-header">
                <div>
                    <h2 id="vehicleManagerTitle" style="margin: 0;">Manage Vehicles</h2>
                    <p style="margin: 4px 0 0; color: #777; font-size: 14px;">Update your delivery fleet without leaving this page.</p>
                </div>
                <button class="modal-close" onclick="closeVehicleManager()" aria-label="Close vehicle manager">&times;</button>
            </div>
            <div class="modal-body">
                <div id="vehicleManagerMessage" class="message"></div>
                <div class="vehicle-manager-grid">
                    <div class="form-group" style="margin: 0;">
                        <label>Vehicle Name</label>
                        <input type="text" id="vehicleManagerName" placeholder="DA1">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Capacity</label>
                        <input type="number" id="vehicleManagerCapacity" placeholder="50" min="1">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Max Distance</label>
                        <input type="number" id="vehicleManagerMaxDistance" placeholder="1000" step="0.1" min="0">
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="vehicleManagerAddVehicle()">Add Vehicle</button>
                <div id="vehicleManagerList" class="vehicle-manager-list">
                    <div class="vehicle-manager-empty">Loading vehicles...</div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="vehicle-manager-actions" style="width: 100%;">
                    <button class="btn" style="background: #ecf0f1; color: #2c3e50;" onclick="vehicleManagerClearAll()">Clear All</button>
                    <button class="btn btn-success" onclick="vehicleManagerSave()">Save Vehicles</button>
                </div>
            </div>
        </div>
    </div>

    <div id="jsonImportOverlay" class="modal-overlay json-import-overlay" aria-hidden="true">
        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="jsonImportTitle">
            <div class="modal-header">
                <div>
                    <h2 id="jsonImportTitle" style="margin: 0;">Import Customer JSON</h2>
                    <p class="helper-text" style="margin: 4px 0 0;">Paste JSON (array or {"customers": []}) or upload a file to override the current customer list.</p>
                </div>
                <button class="modal-close" onclick="closeJsonImport()" aria-label="Close customer import">&times;</button>
            </div>
            <div class="modal-body">
                <div id="jsonImportMessage" class="message"></div>
                <textarea id="jsonCustomerInput" class="json-import-textarea" placeholder='{
    "customers": [
        {"id": "1", "demand": 10, "x": 10.0, "y": 10.0}
    ]
}'></textarea>
                <div class="file-input">
                    <label for="jsonFileInput">Upload JSON file</label>
                    <input type="file" id="jsonFileInput" accept="application/json" onchange="handleJsonFileSelected(event)">
                    <div class="helper-text">Uploading a file replaces the text above.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeJsonImport()">Cancel</button>
                <button class="btn btn-primary" onclick="applyJsonImport()">Apply Customers</button>
            </div>
        </div>
    </div>
    
    <script>
let customers = [];
let currentSolution = null;
let currentRequestId = null;
let agentStatusInterval = null;
let mapData = {
    depot: { x: 0, y: 0 },
    customers: [],
    routes: [],
    vehicles: {},
    unserved: []
};
let mapLayout = null;
let mapUpdateInterval = null;
let baseMapTraces = [];
let vehicleOverlayTrace = null;
let vehicleAnnotations = [];
let vehicleDirections = {};
let vehicleManagerState = {
    vehicles: [],
    loading: false
};
let lastUnservedCustomerIds = new Set();
let lastSolutionSnapshot = null;
let solutionPollTimeout = null;
const TEST_CASES = {
            basic_cvrp: {
                name: 'Test Case 1 â€“ Basic CVRP',
                vehicles: [
                    { name: 'DA1', capacity: 50, maxDistance: 1000 },
                    { name: 'DA2', capacity: 50, maxDistance: 1000 },
                    { name: 'DA3', capacity: 50, maxDistance: 1000 },
                    { name: 'DA4', capacity: 50, maxDistance: 1000 }
                ],
                customers: [
                    { id: '1', demand: 8, x: 15.0, y: 10.0 },
                    { id: '2', demand: 12, x: 25.0, y: 15.0 },
                    { id: '3', demand: 10, x: 35.0, y: 12.0 },
                    { id: '4', demand: 9, x: 20.0, y: 25.0 },
                    { id: '5', demand: 11, x: 30.0, y: 28.0 },
                    { id: '6', demand: 7, x: 40.0, y: 30.0 },
                    { id: '7', demand: 13, x: 10.0, y: 20.0 },
                    { id: '8', demand: 10, x: 18.0, y: 35.0 },
                    { id: '9', demand: 8, x: 28.0, y: 38.0 },
                    { id: '10', demand: 12, x: 38.0, y: 40.0 },
                    { id: '11', demand: 9, x: 5.0, y: 15.0 },
                    { id: '12', demand: 11, x: 12.0, y: 30.0 },
                    { id: '13', demand: 10, x: 22.0, y: 42.0 },
                    { id: '14', demand: 8, x: 32.0, y: 45.0 },
                    { id: '15', demand: 12, x: 42.0, y: 48.0 }
                ]
            },
            demand_shortfall: {
                name: 'Test Case 2 â€“ Demand Exceeds Capacity',
                vehicles: [
                    { name: 'DA1', capacity: 30, maxDistance: 1000 },
                    { name: 'DA2', capacity: 30, maxDistance: 1000 },
                    { name: 'DA3', capacity: 30, maxDistance: 1000 },
                    { name: 'DA4', capacity: 30, maxDistance: 1000 }
                ],
                customers: [
                    { id: '1', demand: 18, x: 15.0, y: 10.0 },
                    { id: '2', demand: 22, x: 25.0, y: 15.0 },
                    { id: '3', demand: 20, x: 35.0, y: 12.0 },
                    { id: '4', demand: 19, x: 20.0, y: 25.0 },
                    { id: '5', demand: 21, x: 30.0, y: 28.0 },
                    { id: '6', demand: 17, x: 40.0, y: 30.0 },
                    { id: '7', demand: 23, x: 10.0, y: 20.0 },
                    { id: '8', demand: 20, x: 18.0, y: 35.0 },
                    { id: '9', demand: 18, x: 28.0, y: 38.0 },
                    { id: '10', demand: 22, x: 38.0, y: 40.0 },
                    { id: '11', demand: 19, x: 5.0, y: 15.0 },
                    { id: '12', demand: 21, x: 12.0, y: 30.0 },
                    { id: '13', demand: 20, x: 22.0, y: 42.0 },
                    { id: '14', demand: 18, x: 32.0, y: 45.0 },
                    { id: '15', demand: 22, x: 42.0, y: 48.0 }
                ]
            },
            distance_constraint: {
                name: 'Test Case 3 â€“ Max Distance Constraint',
                vehicles: [
                    { name: 'DA1', capacity: 50, maxDistance: 50 },
                    { name: 'DA2', capacity: 50, maxDistance: 50 },
                    { name: 'DA3', capacity: 50, maxDistance: 50 },
                    { name: 'DA4', capacity: 50, maxDistance: 50 }
                ],
                customers: [
                    { id: '1', demand: 8, x: 10.0, y: 10.0 },
                    { id: '2', demand: 12, x: 20.0, y: 15.0 },
                    { id: '3', demand: 10, x: 30.0, y: 12.0 },
                    { id: '4', demand: 9, x: 15.0, y: 25.0 },
                    { id: '5', demand: 11, x: 25.0, y: 28.0 },
                    { id: '6', demand: 7, x: 35.0, y: 30.0 },
                    { id: '7', demand: 13, x: 8.0, y: 20.0 },
                    { id: '8', demand: 10, x: 18.0, y: 35.0 },
                    { id: '9', demand: 8, x: 28.0, y: 38.0 },
                    { id: '10', demand: 12, x: 100.0, y: 100.0 },
                    { id: '11', demand: 9, x: 5.0, y: 15.0 },
                    { id: '12', demand: 11, x: 12.0, y: 30.0 },
                    { id: '13', demand: 10, x: 22.0, y: 42.0 },
                    { id: '14', demand: 8, x: 90.0, y: 90.0 },
                    { id: '15', demand: 12, x: 110.0, y: 110.0 }
                ]
            }
        };
let mapBounds = { minX: -10, maxX: 10, minY: -10, maxY: 10 };
let mapDataBounds = { minX: -10, maxX: 10, minY: -10, maxY: 10 };
let baseAxisData = { x: [0], y: [0] };
let routeHistory = [];
let servedCustomerMap = new Map();
let unservedCustomerMap = new Map();
        
        // Initialize map
        function initMap() {
            mapLayout = {
                title: 'CVRP Route Visualization',
                xaxis: { title: 'X Coordinate', scaleanchor: 'y', scaleratio: 1 },
                yaxis: { title: 'Y Coordinate' },
                hovermode: 'closest',
                showlegend: true,
                width: document.getElementById('map').offsetWidth,
                height: document.getElementById('map').offsetHeight,
                margin: { l: 40, r: 20, t: 40, b: 40 }
            };
            
            const depotTrace = createDepotTrace();
            setBaseMapTraces([depotTrace], [0], [0]);
        }

        function createDepotTrace() {
            return {
                x: [0],
                y: [0],
                mode: 'markers',
                type: 'scatter',
                name: 'Depot',
                marker: { size: 15, color: 'red', symbol: 'square' },
                text: ['Depot (0,0)'],
                hovertemplate: 'Depot<br>Location: (0, 0)<extra></extra>'
            };
        }

        function setBaseMapTraces(traces, allX = [], allY = []) {
            baseMapTraces = traces;
            baseAxisData = {
                x: (allX && allX.length ? [...allX] : [0]),
                y: (allY && allY.length ? [...allY] : [0])
            };
            updateAxisRanges(baseAxisData.x, baseAxisData.y);
            renderMapState();
        }

        function renderMapState() {
            if (!mapLayout) return;
            const traces = baseMapTraces.length ? [...baseMapTraces] : [createDepotTrace()];
            if (vehicleOverlayTrace) {
                traces.push(vehicleOverlayTrace);
            }

            const layout = {
                ...mapLayout,
                annotations: vehicleAnnotations.length ? [...vehicleAnnotations] : undefined
            };

            Plotly.react('map', traces, layout, { responsive: true });
        }

        function updateAxisRanges(allX = [], allY = []) {
            if (!mapLayout) return;
            const xValues = (allX && allX.length) ? allX : [mapDataBounds.minX, mapDataBounds.maxX];
            const yValues = (allY && allY.length) ? allY : [mapDataBounds.minY, mapDataBounds.maxY];

            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            const minY = Math.min(...yValues);
            const maxY = Math.max(...yValues);

            mapDataBounds = { minX, maxX, minY, maxY };

            const padding = 5;
            const xRange = [
                Math.floor(minX - padding),
                Math.ceil(maxX + padding)
            ];
            const yRange = [
                Math.floor(minY - padding),
                Math.ceil(maxY + padding)
            ];

            mapBounds = {
                minX: xRange[0],
                maxX: xRange[1],
                minY: yRange[0],
                maxY: yRange[1]
            };

            mapLayout.xaxis = { ...(mapLayout.xaxis || {}), range: xRange };
            mapLayout.yaxis = { ...(mapLayout.yaxis || {}), range: yRange };
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'agents') {
                loadAgentList();
                loadAgentSelect();
                // Start polling agent status every 2 seconds
                if (agentStatusInterval) clearInterval(agentStatusInterval);
                agentStatusInterval = setInterval(loadAgentList, 2000);
            } else if (tabName === 'logs') {
                loadAgentSelect();
                // Stop polling when leaving agents tab
                if (agentStatusInterval) clearInterval(agentStatusInterval);
            } else {
                // Stop polling when leaving agents tab
                if (agentStatusInterval) clearInterval(agentStatusInterval);
            }
        }
        
        function addCustomer() {
            const id = document.getElementById('customerId').value.trim();
            const demand = parseInt(document.getElementById('customerDemand').value);
            const x = parseFloat(document.getElementById('customerX').value);
            const y = parseFloat(document.getElementById('customerY').value);
            
            if (!id || !demand || isNaN(x) || isNaN(y)) {
                showMessage('customerMessage', 'Please fill in all fields', 'error');
                return;
            }
            
            if (customers.find(c => c.id === id)) {
                showMessage('customerMessage', 'Customer with this ID already exists', 'error');
                return;
            }
            
            customers.push({ id, demand, x, y });
            renderCustomers();
            updateMap();
            
            // Clear form
            document.getElementById('customerId').value = '';
            document.getElementById('customerDemand').value = '';
            document.getElementById('customerX').value = '';
            document.getElementById('customerY').value = '';
            
            showMessage('customerMessage', 'Customer added', 'success');
        }
        
        function removeCustomer(id) {
            customers = customers.filter(c => c.id !== id);
            renderCustomers();
            updateMap();
        }
        
        function renderCustomers() {
            const container = document.getElementById('customerList');
            if (customers.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No customers added yet</div>';
                return;
            }
            
            container.innerHTML = customers.map(c => `
                <div class="customer-item">
                    <div class="customer-info">
                        <div class="customer-name">Customer ${c.id}</div>
                        <div class="customer-details">Demand: ${c.demand} | Location: (${c.x}, ${c.y})</div>
                    </div>
                    <button class="remove-btn" onclick="removeCustomer('${c.id}')">Remove</button>
                </div>
            `).join('');
        }
        
        async function submitRequest() {
            if (customers.length === 0) {
                showMessage('customerMessage', 'Please add at least one customer', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/submit-request', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ customers })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentRequestId = data.request_id;
                    lastSolutionSnapshot = null;
                    clearSolutionPoll();
                    showMessage('customerMessage', 'Request submitted! Waiting for solution...', 'success');
                    pollForSolution();
                } else {
                    showMessage('customerMessage', data.error || 'Error submitting request', 'error');
                }
            } catch (error) {
                showMessage('customerMessage', 'Error: ' + error.message, 'error');
            }
        }
        
        async function pollForSolution() {
            if (!currentRequestId) return;
            
            try {
                const response = await fetch(`/api/solution/${currentRequestId}`);
                const data = await response.json();
                
                if (data.status === 'completed' && data.solution) {
                    const snapshot = JSON.stringify(data.solution);
                    const isNewSolution = snapshot !== lastSolutionSnapshot;
                    if (isNewSolution) {
                        lastSolutionSnapshot = snapshot;
                        currentSolution = data.solution;
                        updateMapWithSolution();
                        showMessage('customerMessage', 'Solution received!', 'success');
                    }
                    
                    const remainingUnserved = (data.solution.unservedCustomers || []).length;
                    if (remainingUnserved > 0) {
                        showMessage('customerMessage', `${remainingUnserved} customers remain unserved. Monitoring follow-up run...`, 'error', 4000);
                        scheduleSolutionPoll();
                        return;
                    }
                    
                    currentRequestId = null;
                    clearSolutionPoll();
                } else if (data.status === 'processing' || data.status === 'pending') {
                    scheduleSolutionPoll();
                }
            } catch (error) {
                console.error('Error polling solution:', error);
                scheduleSolutionPoll();
            }
        }
        
        function resetVisualizationState() {
            routeHistory = [];
            servedCustomerMap.clear();
            unservedCustomerMap.clear();
            lastUnservedCustomerIds.clear();
        }

        function buildManualCustomerTrace() {
            if (!customers.length) return null;
            return {
                x: customers.map(c => c.x),
                y: customers.map(c => c.y),
                mode: 'markers+text',
                type: 'scatter',
                name: 'Customers',
                marker: { size: 10, color: '#1f77b4' },
                text: customers.map(c => c.id),
                textposition: 'top center',
                hovertemplate: 'Customer %{text}<br>Demand: %{customdata}<br>Location: (%{x}, %{y})<extra></extra>',
                customdata: customers.map(c => c.demand)
            };
        }

        function rebuildBaseTraces(additionalTraces = []) {
            const traces = [createDepotTrace(), ...routeHistory];
            const servedTrace = buildServedMarkerTrace();
            const unservedTrace = buildUnservedMarkerTrace();
            if (servedTrace) traces.push(servedTrace);
            if (unservedTrace) traces.push(unservedTrace);
            if (additionalTraces.length) traces.push(...additionalTraces);
            const { x: allX, y: allY } = collectTracePoints(traces);
            setBaseMapTraces(traces, allX, allY);
        }

        function updateMap() {
            resetVisualizationState();
            const manualTrace = buildManualCustomerTrace();
            rebuildBaseTraces(manualTrace ? [manualTrace] : []);
        }
        
        function updateMapWithSolution() {
            if (!currentSolution) return;
            
            const previousUnserved = new Set(lastUnservedCustomerIds);
            const currentUnservedIds = new Set(
                (currentSolution.unservedCustomers || []).map(c => getCustomerKey(c))
            );
            const resolvedUnservedIds = new Set(
                [...previousUnserved].filter(id => !currentUnservedIds.has(id))
            );
            lastUnservedCustomerIds = currentUnservedIds;
            
            if (currentSolution.routes) {
                currentSolution.routes.forEach((route, idx) => {
                    const trace = buildRouteTrace(route, idx, resolvedUnservedIds);
                    routeHistory.push(trace);
                    route.customers.forEach(customer => {
                        const key = getCustomerKey(customer);
                        servedCustomerMap.set(key, {
                            ...customer,
                            resolved: resolvedUnservedIds.has(key)
                        });
                        unservedCustomerMap.delete(key);
                    });
                });
            }
            
            if (currentSolution.unservedCustomers) {
                currentSolution.unservedCustomers.forEach(customer => {
                    const key = getCustomerKey(customer);
                    unservedCustomerMap.set(key, { ...customer });
                });
            }
            
            rebuildBaseTraces();
            startMovementTracking();
        }

        function getCustomerKey(customer) {
            if (customer && customer.name) {
                return String(customer.name);
            }
            if (customer && customer.id !== undefined && customer.id !== null) {
                return String(customer.id);
            }
            return `${customer?.x},${customer?.y}`;
        }

        function buildRouteTrace(route, idx, resolvedIds) {
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b'];
            const routeX = [0];
            const routeY = [0];
            route.customers.forEach(customer => {
                routeX.push(customer.x);
                routeY.push(customer.y);
            });
            routeX.push(0);
            routeY.push(0);
            const containsResolved = route.customers.some(customer =>
                resolvedIds.has(getCustomerKey(customer))
            );
            const routeColor = colors[idx % colors.length];
            const labelSuffix = containsResolved ? ' (resolved unserved)' : '';
            
            return {
                x: routeX,
                y: routeY,
                mode: 'lines+markers',
                type: 'scatter',
                name: `Route ${route.vehicleName || idx + 1}${labelSuffix}`,
                line: {
                    color: routeColor,
                    width: containsResolved ? 4 : 2
                },
                marker: {
                    size: containsResolved ? 10 : 8,
                    color: routeColor
                },
                hovertemplate: `Route ${route.vehicleName || idx + 1}<br>Distance: ${route.totalDistance.toFixed(2)}<br>Demand: ${route.totalDemand}<extra></extra>`
            };
        }

        function buildServedMarkerTrace() {
            if (servedCustomerMap.size === 0) return null;
            const customers = Array.from(servedCustomerMap.values());
            return {
                x: customers.map(c => c.x),
                y: customers.map(c => c.y),
                mode: 'markers',
                type: 'scatter',
                name: 'Served Customers',
                marker: {
                    size: customers.map(c => c.resolved ? 14 : 9),
                    color: customers.map(c => c.resolved ? '#2ecc71' : '#95a5a6'),
                    symbol: 'circle'
                },
                text: customers.map(c => c.name || c.id || 'Customer'),
                hovertemplate: 'Customer %{text}<br>Demand: %{customdata}<br>Location: (%{x}, %{y})<extra></extra>',
                customdata: customers.map(c => c.demand)
            };
        }

        function buildUnservedMarkerTrace() {
            if (unservedCustomerMap.size === 0) return null;
            const customers = Array.from(unservedCustomerMap.values());
            return {
                x: customers.map(c => c.x),
                y: customers.map(c => c.y),
                mode: 'markers',
                type: 'scatter',
                name: 'Unserved',
                marker: { size: 12, color: 'orange', symbol: 'x' },
                text: customers.map(c => c.name || c.id || 'Unserved'),
                textposition: 'top center',
                hovertemplate: 'Unserved Customer %{text}<br>Demand: %{customdata}<br>Location: (%{x}, %{y})<extra></extra>',
                customdata: customers.map(c => c.demand)
            };
        }

        function collectTracePoints(traces) {
            const allX = [];
            const allY = [];
            traces.forEach(trace => {
                if (Array.isArray(trace.x)) {
                    allX.push(...trace.x);
                }
                if (Array.isArray(trace.y)) {
                    allY.push(...trace.y);
                }
            });
            return {
                x: allX.length ? allX : [0],
                y: allY.length ? allY : [0]
            };
        }
        
        async function startMovementTracking() {
            if (mapUpdateInterval) clearInterval(mapUpdateInterval);
            
            mapUpdateInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/movement/all');
                    const data = await response.json();
                    
                    if (data.vehicles) {
                        // Update vehicle positions on map
                        updateVehiclePositions(data.vehicles);
                    }
                } catch (error) {
                    console.error('Error fetching movement:', error);
                }
            }, 500);
        }
        
        function updateVehiclePositions(vehicleData) {
            const entries = Object.entries(vehicleData || {});
            if (entries.length === 0) {
                vehicleOverlayTrace = null;
                vehicleAnnotations = [];
                renderMapState();
                return;
            }

            const x = [];
            const y = [];
            const text = [];
            const hover = [];
            const colors = [];

            entries.forEach(([name, info]) => {
                const vx = Number(info.x) || 0;
                const vy = Number(info.y) || 0;
                const status = info.status || 'idle';
                const distance = info.route_id ? `Route: ${info.route_id}` : 'No route';

                x.push(vx);
                y.push(vy);
                text.push(name);
                hover.push(`${name}<br>Status: ${status}<br>${distance}<br>Location: (${vx.toFixed(2)}, ${vy.toFixed(2)})`);
                colors.push(getVehicleColor(status));
            });

            vehicleOverlayTrace = {
                x,
                y,
                text,
                customdata: hover,
                mode: 'markers+text',
                type: 'scatter',
                name: 'Vehicles',
                marker: {
                    size: 14,
                    symbol: 'triangle-up',
                    color: colors,
                    line: { color: '#ffffff', width: 1.5 }
                },
                textposition: 'bottom center',
                hovertemplate: '%{customdata}<extra></extra>'
            };

            vehicleAnnotations = entries.map(([name, info], idx) => createVehicleArrow(name, info, colors[idx]));
            const combinedX = x.length ? baseAxisData.x.concat(x) : baseAxisData.x;
            const combinedY = y.length ? baseAxisData.y.concat(y) : baseAxisData.y;
            updateAxisRanges(combinedX, combinedY);
            renderMapState();
        }

        function getVehicleColor(status) {
            switch (status) {
                case 'moving': return '#27ae60';
                case 'at_customer': return '#f1c40f';
                case 'at_depot': return '#2980b9';
                case 'idle':
                default: return '#7f8c8d';
            }
        }

        function createVehicleArrow(name, info, color) {
            const vx = Number(info.x) || 0;
            const vy = Number(info.y) || 0;
            const targetX = Number(info.target_x);
            const targetY = Number(info.target_y);
            const hasTarget = !Number.isNaN(targetX) && !Number.isNaN(targetY);
            const dx = hasTarget ? targetX - vx : (vehicleDirections[name]?.dx || 1);
            const dy = hasTarget ? targetY - vy : (vehicleDirections[name]?.dy || 0);

            const norm = Math.hypot(dx, dy) || 1;
            const direction = { dx: dx / norm, dy: dy / norm };
            vehicleDirections[name] = direction;

            const arrowLength = 3;
            const headX = vx + direction.dx * arrowLength;
            const headY = vy + direction.dy * arrowLength;

            return {
                x: headX,
                y: headY,
                ax: vx,
                ay: vy,
                xref: 'x',
                yref: 'y',
                axref: 'x',
                ayref: 'y',
                showarrow: true,
                arrowhead: 3,
                arrowsize: 1,
                arrowwidth: 2,
                arrowcolor: color,
                text: ''
            };
        }
        
        async function loadAgentList() {
            try {
                const response = await fetch('/api/agents/status');
                const data = await response.json();
                
                const agentList = document.getElementById('agentList');
                if (data.agents && data.agents.length > 0) {
                    agentList.innerHTML = data.agents.map(agent => {
                        const statusClass = agent.status === 'active' ? 'status-value' : 'status-value error';
                        const statusText = agent.status === 'active' ? 'Active' : 
                                         agent.status === 'inactive' ? 'Inactive' : 'Terminated';
                        const typeLabel = agent.type === 'mra' ? 'MRA' : 'DA';
                        
                        // Build info display
                        let infoHtml = '';
                        if (agent.info) {
                            if (agent.type === 'mra') {
                                // MRA: show depot coordinates
                                const x = agent.info.depot_x !== undefined ? agent.info.depot_x : 0;
                                const y = agent.info.depot_y !== undefined ? agent.info.depot_y : 0;
                                infoHtml = `<div class="agent-info">Depot: (${x.toFixed(1)}, ${y.toFixed(1)})</div>`;
                            } else if (agent.type === 'da') {
                                // DA: show capacity, speed, and max distance
                                const capacity = agent.info.capacity !== undefined ? agent.info.capacity : 'N/A';
                                const speed = agent.info.speed !== undefined ? agent.info.speed : 'N/A';
                                const maxDistance = agent.info.maxDistance !== undefined ? agent.info.maxDistance : 'N/A';
                                infoHtml = `<div class="agent-info">Capacity: ${capacity} | Speed: ${speed} units/s | Max Distance: ${maxDistance}</div>`;
                            }
                        }
                        
                        return `
                            <div class="status-panel">
                                <div class="status-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                        <div>
                                            <span class="status-label">${typeLabel}: ${agent.name}</span>
                                            ${infoHtml}
                                        </div>
                                        <span class="${statusClass}">${statusText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Update status counts
                    document.getElementById('daCount').textContent = data.da_count || 0;
                    const mraActive = data.agents && data.agents.find(a => a.type === 'mra' && a.status === 'active');
                    document.getElementById('mraStatus').textContent = mraActive ? 'Active' : 'Inactive';
                } else {
                    agentList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No agents found. Please confirm vehicles to create agents.</div>';
                    document.getElementById('daCount').textContent = '0';
                    document.getElementById('mraStatus').textContent = 'Inactive';
                }
            } catch (error) {
                console.error('Error loading agents:', error);
                document.getElementById('daCount').textContent = '0';
                document.getElementById('mraStatus').textContent = 'Unknown';
            }
        }
        
        async function loadAgentSelect() {
            try {
                // Use agent status API to get list of active agents
                const response = await fetch('/api/agents/status');
                const data = await response.json();
                
                const select = document.getElementById('agentSelect');
                select.innerHTML = '<option value="">Select an agent...</option>';
                
                if (data.agents && data.agents.length > 0) {
                    // Filter to only show active agents
                    const activeAgents = data.agents.filter(agent => agent.status === 'active');
                    activeAgents.forEach(agent => {
                        const option = document.createElement('option');
                        // Use agent name, but for MRA use 'mra' for log lookup
                        const logName = agent.type === 'mra' ? 'mra' : agent.name;
                        option.value = logName;
                        option.textContent = `${agent.type === 'mra' ? 'MRA' : 'DA'}: ${agent.name}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading agent select:', error);
            }
        }
        
        async function loadAgentLog() {
            const agentName = document.getElementById('agentSelect').value;
            if (!agentName) {
                document.getElementById('logViewer').innerHTML = '<div style="color: #858585;">Select an agent to view logs</div>';
                return;
            }
            
            const logViewer = document.getElementById('logViewer');
            logViewer.innerHTML = '<div style="color: #858585;">Loading log...</div>';
            
            try {
                const response = await fetch(`/api/logs/${agentName}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    logViewer.innerHTML = `<div style="color: #f48771;">Error: ${errorData.error || 'Failed to load log'}</div>`;
                    return;
                }
                
                const data = await response.json();
                
                if (data.content) {
                    const lines = data.content.split('\n');
                    if (lines.length === 0 || (lines.length === 1 && !lines[0].trim())) {
                        logViewer.innerHTML = '<div style="color: #858585;">Log file is empty</div>';
                        return;
                    }
                    
                    logViewer.innerHTML = lines.map(line => {
                        if (!line.trim()) return '<div class="log-entry log-level-info">&nbsp;</div>';
                        
                        let className = 'log-entry';
                        if (line.includes('ERROR') || line.includes('error')) {
                            className += ' log-level-error';
                        } else if (line.includes('WARNING') || line.includes('warning')) {
                            className += ' log-level-warning';
                        } else {
                            className += ' log-level-info';
                        }
                        
                        return `<div class="${className}">${escapeHtml(line)}</div>`;
                    }).join('');
                    
                    logViewer.scrollTop = logViewer.scrollHeight;
                } else if (data.error) {
                    let errorMsg = `<div style="color: #f48771;">Error: ${data.error}</div>`;
                    if (data.message) {
                        errorMsg += `<div style="color: #858585; margin-top: 10px; font-size: 11px;">${data.message}</div>`;
                    }
                    if (data.searched_files) {
                        errorMsg += `<div style="color: #858585; margin-top: 5px; font-size: 11px;">Searched for: ${data.searched_files.join(', ')}</div>`;
                    }
                    logViewer.innerHTML = errorMsg;
                } else {
                    logViewer.innerHTML = '<div style="color: #858585;">No log content available</div>';
                }
            } catch (error) {
                console.error('Error loading log:', error);
                logViewer.innerHTML = `<div style="color: #f48771;">Error loading log: ${error.message}</div>`;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showMessage(elementId, text, type, duration = 3000) {
            const msg = document.getElementById(elementId);
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            if (duration !== null) {
                setTimeout(() => {
                    msg.style.display = 'none';
                }, duration);
            }
        }

        function populateTestCaseSelect() {
            const select = document.getElementById('testCaseSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Select a test case...</option>';
            Object.entries(TEST_CASES).forEach(([id, info]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = info.name;
                select.appendChild(option);
            });
        }

        async function applySelectedTestCase() {
            const select = document.getElementById('testCaseSelect');
            if (!select || !select.value) {
                showMessage('customerMessage', 'Please select a test case to load', 'error');
                return;
            }
            const testCase = TEST_CASES[select.value];
            if (!testCase) {
                showMessage('customerMessage', 'Unknown test case', 'error');
                return;
            }
            await syncTestCaseVehicles(testCase);
            customers = testCase.customers.map(c => ({ ...c }));
            renderCustomers();
            updateMap();
            showMessage('customerMessage', `${testCase.name} loaded`, 'success');
        }

        async function syncTestCaseVehicles(testCase) {
            if (!testCase || !testCase.vehicles) return;
            try {
                const response = await fetch('/api/vehicles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vehicles: testCase.vehicles })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to sync vehicles');
                }
                showMessage('customerMessage', 'Vehicle list updated for test case', 'success');
            } catch (error) {
                console.error('Test case vehicle sync error:', error);
                showMessage('customerMessage', `Vehicle sync failed: ${error.message}`, 'error');
            }
        }

        function openJsonImport() {
            const overlay = document.getElementById('jsonImportOverlay');
            if (!overlay) return;
            const textarea = document.getElementById('jsonCustomerInput');
            textarea.value = JSON.stringify({ customers }, null, 2);
            document.getElementById('jsonFileInput').value = '';
            const msg = document.getElementById('jsonImportMessage');
            if (msg) msg.style.display = 'none';
            overlay.classList.add('active');
            overlay.setAttribute('aria-hidden', 'false');
        }

        function closeJsonImport() {
            const overlay = document.getElementById('jsonImportOverlay');
            if (!overlay) return;
            overlay.classList.remove('active');
            overlay.setAttribute('aria-hidden', 'true');
        }

        function handleJsonFileSelected(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('jsonCustomerInput').value = e.target.result;
                showMessage('jsonImportMessage', `Loaded ${file.name}`, 'success', 2000);
            };
            reader.onerror = () => {
                showMessage('jsonImportMessage', 'Failed to read file', 'error', null);
            };
            reader.readAsText(file);
        }

        function applyJsonImport() {
            const raw = document.getElementById('jsonCustomerInput').value.trim();
            if (!raw) {
                showMessage('jsonImportMessage', 'Please provide JSON content', 'error', null);
                return;
            }
            try {
                const parsed = JSON.parse(raw);
                const importedCustomers = extractCustomersFromJson(parsed);
                customers = importedCustomers;
                renderCustomers();
                updateMap();
                closeJsonImport();
                showMessage('customerMessage', `Imported ${importedCustomers.length} customers from JSON`, 'success');
            } catch (error) {
                console.error('JSON import error:', error);
                showMessage('jsonImportMessage', error.message, 'error', null);
            }
        }

        function extractCustomersFromJson(parsed) {
            const list = Array.isArray(parsed) ? parsed : parsed.customers;
            if (!Array.isArray(list)) {
                throw new Error('JSON must be an array or an object with a "customers" array');
            }
            return list.map((customer, index) => normalizeCustomerFromJson(customer, index));
        }

        function normalizeCustomerFromJson(customer, index) {
            if (customer == null) {
                throw new Error(`Customer at index ${index} is invalid`);
            }
            const id = customer.id !== undefined ? String(customer.id) : null;
            const demand = Number(customer.demand);
            const x = Number(customer.x);
            const y = Number(customer.y);
            if (!id || Number.isNaN(demand) || Number.isNaN(x) || Number.isNaN(y)) {
                throw new Error(`Customer ${index + 1} is missing id, demand, x, or y`);
            }
            if (demand <= 0) {
                throw new Error(`Customer ${id} must have demand > 0`);
            }
            return { id, demand, x, y };
        }

        function scheduleSolutionPoll(delay = 2000) {
            clearSolutionPoll();
            solutionPollTimeout = setTimeout(pollForSolution, delay);
        }

        function clearSolutionPoll() {
            if (solutionPollTimeout) {
                clearTimeout(solutionPollTimeout);
                solutionPollTimeout = null;
            }
        }

        function openVehicleManager() {
            const overlay = document.getElementById('vehicleManagerOverlay');
            overlay.classList.add('active');
            overlay.setAttribute('aria-hidden', 'false');
            loadVehicleManagerData();
        }

        function closeVehicleManager() {
            const overlay = document.getElementById('vehicleManagerOverlay');
            overlay.classList.remove('active');
            overlay.setAttribute('aria-hidden', 'true');
        }

        async function loadVehicleManagerData() {
            if (vehicleManagerState.loading) return;
            vehicleManagerState.loading = true;
            const list = document.getElementById('vehicleManagerList');
            list.innerHTML = '<div class="vehicle-manager-empty">Loading vehicles...</div>';

            try {
                const response = await fetch('/api/vehicles');
                if (!response.ok) {
                    throw new Error(`Failed to load vehicles (${response.status})`);
                }
                const data = await response.json();
                vehicleManagerState.vehicles = (data.vehicles || []).map(v => ({
                    name: v.name,
                    capacity: Number(v.capacity),
                    maxDistance: Number(v.maxDistance)
                }));
                renderVehicleManagerList();
            } catch (error) {
                console.error('Vehicle manager load error:', error);
                list.innerHTML = `<div class="vehicle-manager-empty" style="color: #c0392b;">${error.message}</div>`;
            } finally {
                vehicleManagerState.loading = false;
            }
        }

        function renderVehicleManagerList() {
            const container = document.getElementById('vehicleManagerList');
            if (!vehicleManagerState.vehicles.length) {
                container.innerHTML = '<div class="vehicle-manager-empty">No vehicles defined yet</div>';
                return;
            }

            container.innerHTML = vehicleManagerState.vehicles.map(vehicle => `
                <div class="vehicle-manager-item">
                    <div>
                        <div class="vehicle-manager-item-name">${vehicle.name}</div>
                        <div class="vehicle-manager-item-details">Capacity: ${vehicle.capacity} | Max Distance: ${vehicle.maxDistance}</div>
                    </div>
                    <button class="remove-btn" onclick="vehicleManagerRemoveVehicle('${vehicle.name}')">Remove</button>
                </div>
            `).join('');
        }

        function vehicleManagerAddVehicle() {
            const nameInput = document.getElementById('vehicleManagerName');
            const capacityInput = document.getElementById('vehicleManagerCapacity');
            const maxDistanceInput = document.getElementById('vehicleManagerMaxDistance');

            const name = nameInput.value.trim();
            const capacity = parseInt(capacityInput.value, 10);
            const maxDistance = parseFloat(maxDistanceInput.value);

            if (!name || !capacity || Number.isNaN(maxDistance)) {
                showMessage('vehicleManagerMessage', 'Please fill in all vehicle fields', 'error');
                return;
            }

            if (vehicleManagerState.vehicles.find(v => v.name === name)) {
                showMessage('vehicleManagerMessage', 'Vehicle with this name already exists', 'error');
                return;
            }

            vehicleManagerState.vehicles.push({ name, capacity, maxDistance });
            renderVehicleManagerList();

            nameInput.value = '';
            capacityInput.value = '';
            maxDistanceInput.value = '';

            showMessage('vehicleManagerMessage', 'Vehicle added', 'success');
        }

        function vehicleManagerRemoveVehicle(name) {
            vehicleManagerState.vehicles = vehicleManagerState.vehicles.filter(v => v.name !== name);
            renderVehicleManagerList();
        }

        function vehicleManagerClearAll() {
            if (!vehicleManagerState.vehicles.length) {
                showMessage('vehicleManagerMessage', 'No vehicles to clear', 'error');
                return;
            }
            if (confirm('Clear all vehicles? Existing agents will be recreated with the next confirmation.')) {
                vehicleManagerState.vehicles = [];
                renderVehicleManagerList();
            }
        }

        async function vehicleManagerSave() {
            if (vehicleManagerState.loading) return;
            if (!vehicleManagerState.vehicles.length) {
                showMessage('vehicleManagerMessage', 'Please add at least one vehicle', 'error');
                return;
            }

            vehicleManagerState.loading = true;
            try {
                const response = await fetch('/api/vehicles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vehicles: vehicleManagerState.vehicles })
                });

                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Failed to save vehicles');
                }

                showMessage('vehicleManagerMessage', data.message || 'Vehicles saved', 'success');
                loadAgentList();
            } catch (error) {
                console.error('Vehicle save error:', error);
                showMessage('vehicleManagerMessage', error.message, 'error');
            } finally {
                vehicleManagerState.loading = false;
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') return;
            const vehicleOverlay = document.getElementById('vehicleManagerOverlay');
            if (vehicleOverlay && vehicleOverlay.classList.contains('active')) {
                closeVehicleManager();
            }
            const jsonOverlay = document.getElementById('jsonImportOverlay');
            if (jsonOverlay && jsonOverlay.classList.contains('active')) {
                closeJsonImport();
            }
        });

        document.getElementById('vehicleManagerOverlay').addEventListener('click', (event) => {
            if (event.target === event.currentTarget) {
                closeVehicleManager();
            }
        });
        document.getElementById('jsonImportOverlay').addEventListener('click', (event) => {
            if (event.target === event.currentTarget) {
                closeJsonImport();
            }
        });
        
        // Initialize on load
        window.addEventListener('load', () => {
            initMap();
            loadAgentList();
            populateTestCaseSelect();
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            Plotly.Plots.resize('map');
        });
    </script>
</body>
</html>

